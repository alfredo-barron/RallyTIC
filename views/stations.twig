{% extends 'base.twig' %}
{% block css %}
  <style>
    .map {
      display: block;
      width: 100%;
      height: 440px;
    }
  </style>
{% endblock %}
{% block content %}
  <div class="section no-pad-bot" id="index-banner">
    <br><br>
    <h4 class="header">Carga de estaciones</h4>
    <div class="row">
      <div class="col s4 m4 z-depth-0 white">
        <div class="box">
          <div class="collection">
            <div id="listViewStations"></div>
          </div>
        </div>
      </div>
      <div style="height: 557px;" class="col s8 m8 z-depth-0 indigo lighten-4">
        <br>
        {#<div class="right">
          <a id="btnAddStation" class="waves-effect waves-light btn">Nueva estación</a>
        </div>
        <br><br><br>#}
        <div id="newStation">
          <div class="row">
            <div class="col offset-s1 s10 offset-m1 m10">
              <div class="card">
                <div class="card-content">
                  <span class="card-title black-text"><div id="view_nameteam"></div></span>
                  <div id="map" class="map"></div>
                </div>
                {#<div class="card-action">
                  <a href="javascript:void(0);" id="closeNewStation" name="closeNewStation">Cerrar</a>
                </div>#}
              </div>
            </div>
          </div>
        </div>
        <div id="viewStation">
          <div class="row">
            <div class="col offset-s1 s10 offset-m1 m10">
              <div class="card">
                <div class="card-content">
                  <span class="card-title black-text"><div id="view_nameteam"></div></span>
                  <div id="map2" class="map"></div>
                </div>
                <div class="card-action">
                  <a href="javascript:void(0);" id="closeViewStation" name="closeViewStation">Cerrar</a>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
   </div>
  </div>

<div id="new" class="modal">
    <div class="modal-content">
      <form id="formNewStation" action="{{ urlFor('new-station-post') }}">
      <h4 class="modal-title">Estación</h4>
        <div class="row">
          <div class="input-field col s10 offset-s1 m10 offset-m1">
            <input id="name" name="name" type="text" class="validate">
            <label for="name">Nombre</label>
          </div>
        </div>
        {{ f.hide('lat') }}
        {{ f.hide('lng') }}
    </form>
    </div>
    <div class="modal-footer">
        <a id="btnCancelStation" href="javascript:void(0);" class="modal-action modal-close waves-effect btn red lighten-1">Cancelar</a>
        <button id="btnNewStation" type="submit" class="modal-close waves-effect btn green lighten-1">Guardar</button>
    </div>
</div>

{% endblock %}
{% block js %}
  <script>
    $(document).ready(function(){

      //$('#newStation').hide();
      $('#viewStation').hide();

      $('#btnAddStation').click(function(event) {
        $('#viewStation').hide();
        $('#newStation').show();
        //alert("Estación");
      });

      stations();

      var map = new GMaps({
          div: '#map',
          lat: 22.0030923,
          lng: -99.0203763,
          zoom: 15,
          enableNewStyle: true,
          click: function(event) {
            var lat = event.latLng.lat();
            var lng = event.latLng.lng();
            //alert('Lat: '+lat+"Lng: "+lng);
            $('#lat').val(lat);
            $('#lng').val(lng);
            $('#new').openModal();
          }
      });

      var map2 = new GMaps({
          div: '#map2',
          lat: -12.043333,
          lng: -77.028333
      });

      map.addMarker({
        lat: -12.043333,
        lng: -77.028333,
        title: 'Lima',
        click: function(e) {
          alert('You clicked in this marker');
        }
      });

      GMaps.geolocate({
        success: function(position) {
          map.setCenter(position.coords.latitude, position.coords.longitude);
        }
      });

     /* $(document).on('click', 'a[data-toggle="modal_station"]', function(event) {
        $('#newStation').hide();
        $('#viewStation').show();
        var link = $(this);
        var id = link.data('id');
        team(id);
      }); */

      $('#closeViewStation').click(function(event) {
        $('#viewStation').hide();
      });

      $('#closeNewStation').click(function(event) {
        $('#newStation').hide();
      });

      $('#btnNewStation').click(function(event) {
        var url = $('#formNewStation').attr('action');
        var name = $('#name').val();
        var lat = $('#lat').val();
        var lng = $('#lng').val();
        if (name == "") {
          Materialize.toast('Datos incompletos!', 4000, 'rounded')
        } else {
          $.ajax({
              url: url,
              type: "POST",
              dataType: "json",
              data: $('#formNewStation').serialize(),
              success: function(data) {
                if(data.status == 1){
                  Materialize.toast('Estación&nbsp;<span class="yellow-text">registrada!<span>', 4000, 'rounded')
                  stations();
                  $('#name').val("");
                } else if(data.status == 2){
                  Materialize.toast('Error del servidor!', 4000, 'rounded')
                }
              }
            })
        }
      });

      function stations () {
        $.ajax({
          url: 'stations',
          type: 'GET',
          dataType: 'json',
          data: '',
          success: function(data) {
            if (data.length) {
              $('#listViewStations').empty();
              for (var i = data.length - 1; i >= 0; i--) {
                $('#listViewStations').append('<a href="javascript:void(0);" class="collection-item avatar" data-toggle="modal_station" data-id="'+data[i].id+'"><i class="material-icons circle red left">place</i> Estación <br> <b>'+data[i].name+'</b></a>');
              };
            } else {
              //$('#listViewTeams').append('<h4>Sin grupos</h4>');
              $('#newStation').show();
            };
          }
        });
      }

      function station (id){
        $.ajax({
          url: 'station/'+id,
          type: 'GET',
          dataType: 'json',
          data: '',
          success: function(data) {
            $('#view_namestation').empty();
            $('#view_namestation').html('Equipo <b>'+data.name+'</b> <p>Contraseña: '+data.password+'<p/>');
          }
        });
      }

    });
  </script>
{% endblock %}
